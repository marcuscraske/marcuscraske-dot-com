<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <title> Smart Home - Marcus Craske </title> <meta name="description" content="Personal blog, projects and things of Marcus Craske. Software engineer. Hack the planet!"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, minimum-scale=1"> <meta name="HandheldFriendly" content="True" /> <meta property="og:site_name" content="Marcus Craske"> <meta property="og:type" content="website"> <meta property="og:title" content="Marcus Craske"> <meta property="og:description" content="Personal blog, projects and things of Marcus Craske. Software engineer. Hack the planet!"> <link rel="shortcut icon" href="/favicon.ico"> <link href='/assets/bundle-7725495812616adbd7a29ec1142ebbd1.css' rel='stylesheet' type='text/css' /> <script src='/assets/bundle-d326fb47b9e7e5d81c260da8de38d879.js' type='text/javascript'></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-86993638-1', 'auto'); ga('send', 'pageview'); </script> </head> <body> <a id="skip-to-content" href="#main"> Skip to main content </a> <div class="wrapper-header"> <header> <h1> <a href="/"> Marcus Craske </a> </h1> <p> <a href="https://www.youtube.com/watch?v=Cipc8EowshY"> hack the planet<span class="terminal">|</span> </a> </p> </header> <nav> <ul> <li> <a href="/" class="selected" > <span class="icon-home"></span> Home </a> </li> <li> <a href="/cv"> <span class="icon-file-text2"></span> Résumé / CV </a> </li> <li> <a href="/projects" > <span class="icon-lab"></span> Projects </a> </li> <li> <a href="/links" > <span class="icon-books"></span> Links </a> </li> </ul> </nav> </div> <div class="wrapper"> <main id="main"> <article> <header> <time datetime="2022-02-19"> Feb 19, 2022 </time> <h1> <span class="icon icon-arrow"></span> Smart Home </h1> </header> <p><a href="/assets/posts/2022-02-19-smart-home/microservices.png"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/microservices.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/microservices.png" alt="Smart home dashboard" class="post-thumb" /> </picture> </a></p> <p>Automated lighting, hoovering, heating, energy management and information. A combination of off-the-shelf and hand-cranked code running on a Kubernetes cluster.</p> <p>Mostly completed in December 2019, and tweaked throughout 2020 and 2021.</p> <h2 id="dashboard">Dashboard</h2> <p class="center"> <a href="/assets/posts/2022-02-19-smart-home/dashboard.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/dashboard.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/dashboard.jpg" alt="Dashboard on TV" class="" /> </picture> </a> </p> <p>The centrepiece of the smart home, located near the front door. Lots of data is aggregated from both within the home and external sources, used for checking: weather, train times, share price of the S&amp;P 500, sun-rise/sunset, and general state of the home. This has been particularly useful when leaving home, and checking the train times and whether to take an umbrella. Or leaving last minute for a quick spin on the bike, and checking the wind direction to plan a route.</p> <p>The floor plan shows the colour of the lights, and temperature, in each room, with some lights supporting RGB, and motion sensors, with those recently activated in green.</p> <p>The TV its self is just using a Raspberry Pi, with an Electron (Node.js) app launching on startup. The app displays an external web-page, and periodically polls an externally hosted service to check whether to turn the screen off, when there’s no motion in the room.</p> <p>The externally hosted resources are on a Kubernetes cluster, which we’ll delve into in the upcoming sections.</p> <h2 id="microservice-architecture">Microservice Architecture</h2> <p>The data displayed on the dashboard is derived from multiple microservices:</p> <p class="center"> <a href="/assets/posts/2022-02-19-smart-home/microservices.png"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/microservices.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/microservices.png" alt="Microservice diagram" class="" /> </picture> </a> </p> <h2 id="why-microservices">Why Microservices?</h2> <p>Admittedly overkill for a project of this size.</p> <p>Most of the services are only a few scripts large, but each one has a clear purpose, and can fail without taking down the entire ecosystem. This is important for one service in particular, which interfaces with a device using USB, and can be prone to hardware issues, causing the service to hang or slow-down.</p> <p>Updates can be easily performed to a single service, without affecting the overall functionality. For example, updating the <em>Dashboard</em> without affecting automation scripts, which are otherwise performing actions on the home. And if an update fails, most of the functionality continues to work, and can be fixed another day.</p> <h2 id="why-kubernetes">Why Kubernetes?</h2> <p>The microservices needed to run on something, and reliability is important, especially for <em>Home Actions</em>, which is running automated scripts to control the home.</p> <p>Using a Raspberry Pi makes sense for running the microservices, due to the low power consumption, but they’re notorious for failing due to MicroSD cards burning out. Running on a single machine could leave the entire system not working for days, or longer, if there isn’t time to rectify problems.</p> <p>Instead, Kubernetes allows for building a distributed system, spreading loads across multiple machines (Raspberry Pi’s), useful for mitigating such failure. It reduces the risk of regular maintenance, allowing for each machine to be patched and re-introduced one at a time. And in the event of problems, removed from the Kubernetes cluster and left to be fixed another day.</p> <p>This project was also a good example to build on a previous post, <a href="/2019/09/21/raspberry-pi-kubernetes-cluster/">running a Kubernetes cluster on Raspberry Pi’s</a>.</p> <h2 id="service-stack">Service Stack</h2> <p>Each service uses the <em>node</em> (Node.js) Docker container image, using <a href="https://expressjs.com/">Express</a> for building simple APIs. Since we’re running these images on Raspberry Pi’s, with the ARM instruction set, image builds are done remotely over SSH on the Kubernetes master node.</p> <h2 id="the-services">The Services</h2> <p><strong>Dashboard:</strong> displaying data from the other services, as seen on the TV shown previously, accessible to any device on both the local network and internet. Built using React, with each section built as its own one or more components.</p> <p><strong>Bin Collection:</strong> perhaps known as garbage collection outside the UK, is usually every week. But the days can switch between Friday and Saturday, and become even stranger around public holidays. A <em>council</em> is responsible for the collection of garbage, a local government organisation. And collection dates are published on their website. Unfortunately, they don’t provide a public API, so the service scrapes their website, reading the data from the page. The service then provides a simple JSON API for the other services.</p> <p><strong>Weather:</strong> sourced for free from <a href="https://openweathermap.org/">OpenWeather</a>, this was the most accurate of a few services trialed over a period of time, and able to provide predictions for a few days, down to individual hours.</p> <p><strong>Uptime:</strong> pinging the Google homepage every second, used to track internet problems within the last 24 hours.</p> <p><strong>Trains:</strong> data is retrieved, for the station closest to my home, using the <a href="https://wiki.openraildata.com/index.php/NRE_Darwin_Web_Service_(Public)">National Rail Live Departure Boards Web Service</a> (LDBWS) SOAP API, . It’s the same API used by the National Rail Enquiries website. And the data is derived from the <a href="https://wiki.openraildata.com/index.php?title=TRUST_vs_Darwin#Darwin">National Rail Darwin</a> system, the same data used for the departure boards across UK stations.</p> <p><strong>Share Price:</strong> retrieving share price information, updating every five minutes, for a given symbol. This used the free <a href="https://finnhub.io/">Finnhub Stock API</a>. Although, I only ever displayed <em>SPY</em> (S&amp;P 500).</p> <p><strong>Philip Hue:</strong> all the lights and motion sensors use Philip Hue, which has a bridge/hub device for controlling and retrieving state information. This service throttles requests from other services, as well as simplifying bulk interaction, such as fetching or pushing state to all the lights and/or sensors within a room. Throttling is important, as the bridge is incredibly underpowered, and it doesn’t take many requests to inadvertently cause a denial of service attack. Which happened a few times at the start of the project, and the lights wouldn’t turn on automatically in the rooms…like being back in the stone age, or what most typical homes still have today.</p> <p><strong>Power Plugs:</strong> almost every appliance has a smart plug, which can measure the power usage in watts, and turn on/off power, using the Tuya cloud API. Huge kudos to the <a href="https://github.com/codetheweb/tuyapi">tuyapi</a> project for simplifying connectivity.</p> <p><strong>Power Usage:</strong> this is one of the interesting sources of information, as it provides the power usage for the entire house. British Gas, many years ago, were handing out the <a href="http://www.currentcost.com/product-cc128.html">CC128</a> energy monitor for free. You just put a clamp, hooked up to a wireless battery pack, around the mains electric, in the outdoor utility box. This is able to measure the total power usage by measuring the magnetic field of the cable, using the <a href="https://en.wikipedia.org/wiki/Hall_effect#Split_ring_clamp-on_sensor">hall effect</a>. It turns out the CC128 has a serial bus on the back, which outputs the power usage as XML. You can buy a CC128 on eBay, and just need a USB to serial adapter. This unfortunately means the service must be tied to a fixed instance (Raspberry Pi).</p> <p><strong>Home Actions:</strong> running automation scripts, more detail in the next section.</p> <h2 id="automation-scripts">Automation Scripts</h2> <p>The <em>Home Actions</em> service had a few automated scripts, consuming data and performing actions on the <em>Power Plugs</em> and <em>Philip Hue</em> services:</p> <ul> <li><strong>Turning on the treadmill fan,</strong> when the treadmill is used, based on the power consumption of the treadmill smart plug going above an idle threshold (in watts).</li> <li><strong>Turning off the living room lights and motion sensor,</strong> when a projector is turned-on, again based on plug power consumption, but for the projector.</li> <li><strong>Turning off all the smart plugs when the house is idle,</strong> based on 30 minutes of inactivity on all the motion sensors, which are in every single room. And then turning them back on, when motion is detected again.</li> <li><strong>Turning on the (dashboard) TV when motion is detected in the kitchen,</strong> saving a significant amount of energy.</li> </ul> <h2 id="smart-appliances">Smart Appliances</h2> <p><em>This section is not sponsored, I promise…</em></p> <p><strong>Philip Hue lighting</strong> throughout the entire interior and exterior of the house. Motion sensors in every room automatically turn on, and eventually off, every single light. Each bulb is ultra energy efficient, using 7 watts each. A typical LED bulb uses 9 watts, or incandescent bulb uses 100 watts. And an RGB LED floodlight, using 15 watts, for the outdoor carpark space - a typical halogen floodlight uses 200-400 watts. Thus significant energy savings. And a front door light, synchronised with sunrise/sunset. The light switch in each room has been covered with a 3D printed mount, purchased from Etsy, to fit a standard Philip Hue remote.</p> <p><strong>Roborok S5 Max Robovac</strong> both upstairs and downstairs, running twice a week, cleaning the floors, including mopping. Requiring typically fortnightly maintenance: emptying of the onboard bin, cleaning the brush and refilling the water tank. Although, I suspect it wouldn’t do well with animal hair, as human hair was enough to cripple it at times.</p> <p><strong>Hive Smart Heating</strong> isn’t particularly different to a time-controlled thermostat, other than it can be controlled through a mobile app, and run different schedules for different days. Super useful to turn off the heating when going on holiday, and turning it on remotely before getting home.</p> <p><strong>Foscam IP Cameras</strong> were an unusual choice, but I wanted something that worked entirely offline due to privacy concerns. These cameras are well-established in corporate environments due to reliability, and often appeared on leaked camera lists, on forums and discussion boards, when they were misconfigured. Although if I were to pick new cameras, I’d probably look at Reolink. In total, I had 2x 1080p and 1x 1440p (2k) cameras, recorded using <a href="https://github.com/ccrisan/motioneyeos/wiki">MotionEyeOS</a>, at 12 FPS, with footage stored for two weeks, in a locked cabinet on WD Purple NVR drives (in RAID1), and automatically uploaded to Dropbox.</p> <p><strong>Aoycocr Smart Plugs</strong> providing individual power usage, and control, of appliances remotely. Make sure to get a model which can monitor power, as most do not. Just search for <em>smart plug power monitor</em> on Amazon, and check it explicitly mentions energy monitoring, and it’s Tuya compatible.</p> <p><em>And best of all…</em></p> <p>Most of the above smart appliances can be accessed through smart apps over the internet, what could go wrong? ;)</p> <h2 id="photos">Photos</h2> <ul class="gallery"> <li> <a href="/assets/posts/2022-02-19-smart-home/bridges.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/bridges.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/bridges.jpg" alt="Philip Hue and Hive bridges, used for remote control" class="" /> </picture><span>Philip Hue and Hive bridges, used for remote control</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/cabinet.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/cabinet.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/cabinet.jpg" alt="Rack mounted in a 42U server cabinet, although the cabinet is not exclusively for this project" class="" /> </picture><span>Rack mounted in a 42U server cabinet, although the cabinet is not exclusively for this project</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/heating-receiver.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/heating-receiver.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/heating-receiver.jpg" alt="Hive heating receiver" class="" /> </picture><span>Hive heating receiver</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/heating-thermostat.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/heating-thermostat.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/heating-thermostat.jpg" alt="Hive heating thermostat control" class="" /> </picture><span>Hive heating thermostat control</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/light-covered.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/light-covered.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/light-covered.jpg" alt="Philip Hue mount over normal light switch, with magnetic removable remote" class="" /> </picture><span>Philip Hue mount over normal light switch, with magnetic removable remote</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/light-uncovered.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/light-uncovered.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/light-uncovered.jpg" alt="Philip Hue mount cover removed" class="" /> </picture><span>Philip Hue mount cover removed</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/pi-rack.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/pi-rack.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/pi-rack.jpg" alt="Raspberry Pi 1U rack mount shelf" class="" /> </picture><span>Raspberry Pi 1U rack mount shelf</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/robovac-downstairs.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/robovac-downstairs.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/robovac-downstairs.jpg" alt="Robovac (downstairs)" class="" /> </picture><span>Robovac (downstairs)</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/robovac-upstairs.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/robovac-upstairs.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/robovac-upstairs.jpg" alt="Robovac (upstairs)" class="" /> </picture><span>Robovac (upstairs)</span> </a> </li> <li> <a href="/assets/posts/2022-02-19-smart-home/smart-plugs.jpg"> <picture> <source srcset="/assets/posts/2022-02-19-smart-home/smart-plugs.webp" type="image/webp" /> <img src="/assets/posts/2022-02-19-smart-home/smart-plugs.jpg" alt="Some of the smart plugs" class="" /> </picture><span>Some of the smart plugs</span> </a> </li> </ul> <h2 id="conclusion">Conclusion</h2> <p>A lot of the custom aspects of the project could have used off-the-shelf platforms, such as <a href="https://www.apple.com/uk/ios/home/">Apple HomeKit</a> or <a href="https://www.openhab.org/">openHAB</a>.</p> <p>But what value does custom bring?</p> <ol> <li>Integrating and scripting different platforms together, although openHAB probably offers similar and makes it easier.</li> <li>The dashboard, which is completely customisable, and one of the main reasons for this project.</li> <li>Learning.</li> <li>Flexing that one’s house runs on JavaScript.</li> </ol> <p>What about maintenance and issues?</p> <ul> <li>A home automation script had a bug, which spammed the Philip Hue service, and caused a denial of service attack on the Philip Hue Bridge. The remote switches and motion sensors rely on the Philip Hue bridge to turn the lights on. And unfortunately, the issue occurred at night, so I had to stumble through the house, in the dark, with my phone torch to get to my desk to undeploy the service. Such a first world problem. The bug was later rectified, and throttling added to the Philip Hue service as a fail-safe.</li> <li>The certificates used by Kubernetes expired, causing the Kubernetes API to stop working, along with service communication, which included internet and local service-to-service connectivity. This was later fixed by renewing the certificates.</li> </ul> <p>Overall, it’s been an interesting ongoing project for the last two years. And despite moving house soon, I will be carrying forward this setup.</p> <section id="comments"> <h2> Comments </h2> <script id="dsq-count-scr" src="//limpygnome-com.disqus.com/count.js" async></script> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = PAGE_URL; this.page.identifier = PAGE_IDENTIFIER; }; (function() { var d = document, s = d.createElement('script'); s.src = '//limpygnome-com.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </section> </article> </main> </div> <footer> <p class="disclaimer"> Disclaimer: this is a personal blog, any opinions and actions are my own and do not represent my employer. </p> <ul> <li> <a href="https://opensource.org/licenses/MIT"> MIT License </a> </li> <li> <a href="https://www.w3.org/WAI/standards-guidelines/wcag"> WCAG 2.1 AA Friendly </a> </li> </ul> <p class="socials"> <a title="Github" href="https://www.github.com/marcuscraske"> Github </a> <a title="LinkedIn" href="http://www.linkedin.com/in/marcuscraske"> LinkedIn </a> <a title="Instagram" href="https://www.instagram.com/marcuscraske"> Instagram </a> <a title="Twitter" href="https://twitter.com/marcuscraske"> Twitter </a> <a title="Strava" href="https://www.strava.com/athletes/marcuscraske"> Strava </a> <a title="Mastodon" href="https://hachyderm.io/@marcuscraske" target="_blank"> Mastodon </a> <a title="E-mail" href="mailto:contact@marcuscraske.com" target="_blank"> E-mail </a> </p> </footer> <script type="text/javascript"> SyntaxHighlighter.all(); $('.blog').jscroll({ contentSelector: ".blog", nextSelector: ".next" }); </script> </body> </html>
